# 様々な制御

前章では、pandoc-crossrefにより図に番号を付けたり、それを参照したりする方法を説明しましたが、色々と直したいところも出てきます。日本語なのですからキャプションに「Figure」ではなく「図」と付けたいですし、参照のリンクが「fig. 1」と数字の部分だけに置かれていては読者に気付いてもらえないかもしれません。
pandoc-crossrefは、制御ファイルを使ってそれらを変更できます。本章では、前章同様、図を例に採ってこのような制御について説明します。

## キャプション書式の制御

まず、キャプションの書式の構造を説明します。  
pandoc-crossrefでは、図のキャプション文字列の構造は、下図のようになっています。

図3:図キャプションの構造

「変数」が前置されているものは、pandoc-crossrefの制御ファイルで設定できます。また、デフォルト値にある `$$xx$$`という表記は、「変数`xx`の値」がその部分に挿入されることを表します。

表1: 図キャプションの部品要素

|役割 |デフォルト |値 |
|- |- |- |
|変数 `figureTemplate` |図キャプションの書式 |`$$figureTitle$$` <br> `$$i$$$$titleDelim$$$$t$$` |
|変数 `figureTitle` |キャプションに前置される文字列|`Figure`|
|変数 `titleDelim` |前置される文字列と番号を区切る文字列|`:`|
|図の連番i|図に付番された番号|`NA`|
|キャプションt|Markdown中に書かれたキャプション|`NA`|

図2に表示されている図のキャプションは、変数`figureTemplate`で指定される書式に従って作られた文字列です。
デフォルト値では、変数 `figureTitle` が `Figure` 、変数 `titleDelim`が `:` ですから、図2に示したように、図に付けられるキャプションは「`Figure`図番号:Markdownに書かれたキャプション」となります。  
ここで、「図番号」は、pandoc-crossrefが自動的に図に与えた番号の文字列です。

図キャプションの書式は変数`figureTemplate`で決まるのですから、そのデフォルト値がしているように変数`FigureTitle`等の他の変数を参照する必要は、必ずしもありません。
例えば、変数`figureTemplate`に含まれている`$$titleDelim$$`を`:`に置き換えても、同じキャプションを作れます。
変数`figureTemplate`の値を書き換えるには、pandoc-crossrefの制御ファイルに変数名をキーとするハッシュを書きます。前章のサンプルですと、下記の行をcrossref.yamlに書き加えることになります。

リスト5:変数`titleDelim`を使わない例

```
# このハッシュは、変数の値を書き換えます。
figureTemplate: $$i$$: $$t$$  # 変数titleDelimの代わりに、直接「:」を書きました。
```

ただし、変数`titleDelim`は表など他の種類のキャプションの区切り記号にも統一感を出すために使われていますので、できるだけこの変数を利用するようお勧めします。

### 番号の文字種

図番号の文字種を制御するには、変数`figLabels`を用います。設定する値と番号の形式を下表に掲げます。

表2:番号文字の文字種

|設定する値|制御ファイルでの書き方例|表示例|メモ|
|- |- |- |- |
|`arabic`|`figLabel:arabic`|1,2,3…||
|`roman`|`figLabel:roman`|I,II,III,IV,…||
|`lowercase`|`figLabel:lowercase`|i,ii,iii,iv,…||
|`alpha x` |`figLabel:alpha d`| d,e,f,…||
|列挙|`figLabel:[イ,ロ,ハ,ニ]` |イ,ロ,ハ,ニ|使うものすべてを列挙してください。|

### 連番の振り方

図番号は、文書全体での連番、または、各章などの中での連番です。

変数`chapters`により、どちらにするかを決められます。なお、変数`chapters`は表や式などの付番にも影響しますので、ご注意ください。

表3:連番の振り方

|変数chaptersの値|連番の振り方|
|- |- |
|`false` |文書内全体を通しての連番（デフォルト値）|
|`true` |章や節ごとに1番から始まる連番|

変数`chapters`が`true`の時には、以下のような形で連番が付けられます。

図4:章ごとの連番

章や節のどの範囲で連番を付けるかは、変数`chaptersDepth`で決められます。この変数には、番号をリセットしたいヘッダレベルを設定してください。例えば、ヘッダレベル1を章に割り当てている場合、表4のようになります。

表4:連番の範囲

|変数`chaptersDepth`の値|連番の範囲|
|- |- |
|0|文書全体を通じて連番を付加する。|
|1|章ごとに番号をリセットし、図番号に章番号を付加する。デフォルト値。|
|2|節ごとに番号をリセットし、図番号に章番号と節番号を付加する。|
|3|以上項番号ごとなどになり、以下同様。|

章ごとなどの連番の場合に章番号と連番を区切る文字は、変数`chapDelim`の値で、デフォルト値は`.`です。


## 参照書式の制御

pandoc-crossrefでは、図の参照文字列の構造は、下図のようになっています。

図2に表示されている図の参照には、変数refIndexTemplateに従って作られた文字列が使われています。デフォルト値では変数`figPrefixTemplate`が`$$p$$&nbsp;$$i$$`、変数`figPrefix`が`fig.`ですから、「fig. 図番号」となります。
なお、`&nbsp;`は、改行を許さない空白文字です。

表5:参照文字列部品

|要素 |役割 |デフォルト値 |
|- |- |- |
|変数 `refIndexTemplate`  |参照文字列の書式|`$$i$$$$suf$$`|
|変数 `figPrefixTemplate` |図番号の書式|`$$p$$ $$i$$`|
|変数 `figPrefix` |連番に付けるプレフィックス|`fig.`, `figs`|
|サフィックス `suf`|参照の中に書かれたsuffix|`NA`|
|キャプション `t`|参照先の図のキャプション|`NA`|
|図の連番`i`(`figPrefixTemplate`内)|参照先の図に付けられた連番|`NA`|
|整形済連番`i`(`refIndexTemplate`内)|変数`figPrefixTemplate`の評価値|`NA`|

### 変数`figPrefix`

参照に付けられるプレフィックスを指定する変数`figPrefix`は、単数形と複数形を指定できる
リストです。

複数形は、4.4節で説明するように、複数の図を参照する場合に用いられます。
制御ファイル内に書くと、以下のようになります。

```
figPrefix:
-fig.
-figs.
```

複数形がなければ、以下のように単なる変数としても問題ありません。

```
figPrefix:図
```

### サフィックス

サフィックスは、それぞれの参照で指定する、図番号の後ろに付ける文字列です。

通常の参照の書き方は`[@fig:id]`ですが、`[@fig:idsuffix]`のようにサフィックスとして任意の文字列を付け加えることができます。サフィックスをダブルクォーテーションで括らないでください。括ると、ダブルクォーテーションもサフィックスの一部とみなされます。サフィックス文字列の中に2個以上連続した空白文字がある場合、1個にまとめられます。

例えば、図2にある参照を書く時に`[@fig:monumentIdThisissuffix]`と書けば、参照の文字列が以下のようになります。

```
fig. 1 This is suffix
```

### プレフィックス変更

変数`figPrefix`で決まる参照のプレフィックス部分を、それぞれの参照でオーバーライドできます。  
通常プレフィックスには変数`figPrefix`の値が使われて「fig. 1」となりますが、参照時に`[myprefix@fig:monumentId]`と書くと、変数`figPrefix`の代わりに参照に書かれたプレフィックスが使われて`myprefix1`となります。プレフィックスもサフィックスと同様に任意の文字列を書けます。ダブルクォーテーションも文字列の一部とみなされることと複数の連続する空白が一つにまとめられることも同じです。

プレフィックスとサフィックスの両方を一つの参照に指定できます。

### プレフィックス抑制

以下の書き方をすると、参照内にプレフィックスを表示しません。

リスト6:プレフィックスを抑制する記法

```
[-@fig:monumentId]
```

このように書くと、図5の中段にある変数`figPrefixTemplate`が省略されて、図番号が上段にある変数`refIndexTemplate`の「`$$i$$`」の値として使われます。

「`-`」の後ろに空白文字を置くと、プレフィックス変更と解釈されてしまいます。間を開けずに書きましょう。

### キャプションを含める

変数`t`を用いて、参照書式に図のキャプションを含めることができます。変数`t`は、変数`refIndexTemplate`など書式を決める変数の定義の中でのみ使えます。

変数`refIndexTemplate`のデフォルト値は「`$$i$$$$suf$$`」ですが、これに「`$$t$$`」を付け加えて「`$$i$$$$suf$$$$t$$`」とすると、参照書式が以下のようになります。

```
「fig. 1図のキャプション」
```

## 種類ごとの参照書式

参照書式を決める変数refIndexTemplateはシンプルな文字列として書式を保持していますから、それを変更すると、図だけではなく表や式などにも影響します。これを避けるには、この変数を、図専用の書式とそれ以外の書式を区別して保持するディクショナリーにします。

リスト7:refIndexTemplateをディクショナリーにする

```
refIndexTemplate:
  fig: $$i$$$$suf$$&nbsp;$$t$$
  default: $$i$$$$suf$$
```

このようにしておけば、図の参照書式だけにキャプションが表示されるようになります。

表や式などにもそれぞれ異なる参照書式を使いたい場合には、下表のように書いてディクショナリーに追加すれば実現できます。

変数refIndexTemplateの値の中だけで使える変数t・suf・iは、図と同様に表や式などでも使えます。

表6:種類ごとの参照書式

|要素 |書き方の例 |
|- |- |
|図|`fig: $$i$$$$suf$$ $t$$`|
|表|`tbl: $$i$$:$$t$$`|
|式|`eq: $$i$$`|
|リスティング|`lst:$$i$$ $$t$$`|
|章や節|`suf: $$i$$$$suf$$$$t$$`|
|定義されていない要素すべて|`default: $$i$$$$suf$$`|

## 参照の制御

この節では、書式以外の点で図などへの参照を制御する方法を説明します。

### 参照からリンクを張る

pandoc-crossrefのデフォルトでは、図番号への参照から図へのリンクが張られません。リンクを張るには、変数`linkReference`を`true`にしなければなりません。pandoc-crossrefの制御ファイルであるcrossref.yamlに、以下の行を追加しましょう。

リスト8:参照からリンクを張るための設定
```
linkReference: true
```

この設定は、表や式などにも有効です。

### プレフィックスもリンクに含める

参照のリンクは、図2に示すように、参照文字列の番号の部分だけにしか置かれていません。これではクリックしにくいですし、図番号と言えばプレフィックスまで含めて考えるのが普通でしょう。

変数`nameInLink`を`true`にすることにより、プレフィックスにもリンクが置かれるようになります。
pandoc-crossrefの制御ファイルであるcrossref.yamlに、以下の行を追加しましょう。

リスト9:参照のプレフィックスにもリンクを置くための設定
```
nameInLink: true
```

このようにすると、図2の参照とは異なり図6のようにプレフィックスの部分にもアンダーラインが引かれて、リンクが置かれていることが分かります。

図6:プレフィックスにもリンク

参照にサフィックスを書いている場合には、サフィックスの部分にもリンクが置かれます。

この設定は、表や式などにも有効です。

### 複数参照

複数の図に対する参照をまとめて書くことができます。

```
単独の参照: [@fig:id1]
複数の参照: [@fig:id1;@fig:id2;…]
```

参照を括る大括弧の中に複数の参照先をセミコロンで区切って書くだけです。

表2に示す番号の文字種がarabicの場合、連番の図が参照される時には全部を列挙するのではなく、それらをまとめて範囲を表示にされます。連番でなければ、カンマで区切って列挙されます。

例を下表に示します。

複数参照の例{#tbl: 複数参照の例}

|参照する数|参照表記|参照文字列|
|- |- |- |
|1個|`[@fig:id1]`|fig. 1|
|連番2個|`[@fig:id1;@fig:id2]`|figs.1,2|
|連番3個|`[@fig:id1;@fig:id2;@fig:id3]`|figs.1-3|
|飛び番2個|`[@fig:id1;@fig:id3]`|figs.1,3|
|飛び番3個|`[@fig:id1;@fig:id3;@fig:id5]`|figs.1,3,5|
|混合4個|`[@fig:id1;@fig:id2;@fig:id3;@fig:id5]`|figs.1-3,5|

連番や飛び番の区切り文字は、以下の変数により設定できます。

連番や飛び番の区切り文字{#tbl:連番や飛び番の区切り文字}

|変数名|役割|デフォルト値|例|変更例|変更した表示|
|- |- |- |- |- |- |
|`rangeDelim`|3個以上の連番の時に範囲を示す区切り文字|`-`|figs.1-3|`to`|figs.1to3|
|`pairDelim`|2個を列挙する時の区切り文字|`,`|figs.1,3|`and`|figs.1 and 3|
|`refDelim`|3個以上を列挙する時の最後以外の区切り文字|`,`|figs.1,3,5|`,`|figs.1,3,5|
|`lastDelim`|3個以上を列挙する時の最後の区切り文字|`,`|figs.1,3,5|`, and`|figs.1,3, and5|


それぞれの区切り文字と図番号の間には、空白文字を含めて自動的には何も表示されません。読みやすくするために、区切り文字の前後に適切な空白文字を含めるようお勧めします。変数refDelimの変更例には、空白文字を置かなかった場合の表示を掲げてみました。

上記の変更例を設定するpandoc-crossref設定ファイルの記述は、以下の通りです。

リスト10:連番などの区切り文字を設定する
```
rangeDelim: "to"
pairDelim: "and"
refDelim: ","
lastDelim:",and"
```

## 生成されるHTML

本書ではPandocが生成するHTMLを掲載します。図や表に対して生成されるHTMLの構造が分かれば、CSSを使って望みの見た目を作れるからです。

本書で掲載するHTMLは、Pandocが生成したものそのままではなく、わかりやすいように整形しています。HTMLタグの順序・入れ子・兄弟関係・属性などは生成されたままですが、改行を挿入したり、空白を挿入削除したりしています。

### 図番号のHTML

既出の通り、図番号付きで画像を取り込むMarkdownは、以下の通りです。

リスト11:図番号付きの画像

```
![図のキャプション](monument.jpg "imageTitle"){#fig:monumentId}
```

このMarkdownに対して、以下のHTMLが生成されます。

リスト12:図番号付き画像のHTML
```html
<figure id="fig:monumentId">
    <img src="monument.jpg" title="imageTitle" alt="図のキャプション">
    <figcaption>
        Figure1:図のキャプション
    </figcaption>
</figure>
```

Markdownで指定したIDがfigureタグのid属性で設定されています。
キャプションは、figcaption要素とimg要素のalt属性に設定されています。
図を表示するimg要素とキャプションは、figure要素内にまとめられています。第4.5.2項図番号参照のHTML図を参照するMarkdownは、以下の通りです。

リスト13:図参照

```
[@fig:monumentId]
```

このMarkdownに対して生成されるHTMLは、図に番号がついている場合、以下の通りです。

リスト14:図参照のHTML

```html
<a href="#fig:monumentId">fig.&nbsp;1</a>
```

図の参照は、単純にa要素で表現されています。

a要素のコンテントは、4.2節に示した方法で作られた文字列です。

### 表現を変更する

HTMLの構造が分かれば、CSSで表現を変えることができます。例として、図2では画面の左側に寄っている図を中央寄せして、図の範囲が分かりやすいように線で囲ってみましょう。

以下の内容のファイルpandoc.cssを作ってください。文字コードは、UTF-8でなければなりません。

リスト15:pandoc.css
```css
<style>
    figure{
        padding-top: 0.5em;
        border: 1px solid #404040;
        text-align: center;
    }
</style>
```

そして、pandoc.yamlに以下の二行を追加します。

リスト16:CSS取り込み
```yaml
include-in-header:
    - InHeader.css
```

`include-in-header`により、pandoc.cssの内容が生成されたEPUBやHTMLに挿入されます。
挿入場所はPandocが自動的に挿入するstyle要素の直後ですから、元々Pandocが定義している表現をオーバーライドできます。

EPUBやHTMLを生成させると、図2の表示が下図のように変わります。

図2と比べると、画像の表現が変わっていることがはっきりわかります。
このように、生成されるHTMLの特徴を利用して表現を変えることができます。

なお、参照側は単純にaタグを使っていますので、CSSで表現を変えるとすべてのリンクの書式が変わってしまいます。図のリンクの書式だけを変えることはできません。

